<!DOCTYPE html>
<html>
<head>
    <title>Geometric Algebra Visualization</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .viz-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls { margin-top: 15px; }
        input[type="range"] { width: 200px; }
        label { display: inline-block; width: 120px; }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.fallback { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Geometric Algebra Visualizer</h1>
    <div id="status" class="status">Loading...</div>
    
    <div class="container">
        <!-- PGA 2D Demo -->
        <div class="viz-panel" id="pga2d-container">
            <h3>2D Projective GA (PGA)</h3>
            <div id="pga2d-graph"></div>
            <div class="controls">
                <label>Rotation:</label>
                <input type="range" id="rotation2d" min="0" max="360" value="0">
                <span id="rotation2d-val">0°</span>
            </div>
        </div>
        
        <!-- PGA 3D Demo -->
        <div class="viz-panel" id="pga3d-container">
            <h3>3D Projective GA (PGA)</h3>
            <div id="pga3d-graph"></div>
            <div class="controls">
                <label>Rotation X:</label>
                <input type="range" id="rotationX" min="0" max="360" value="0">
                <span id="rotationX-val">0°</span><br>
                <label>Rotation Y:</label>
                <input type="range" id="rotationY" min="0" max="360" value="0">
                <span id="rotationY-val">0°</span>
            </div>
        </div>
    </div>

    <!-- Vanilla GA fallback (always available) -->
    <script src="ga_vanilla.js"></script>
    
    <script>
    // ========================================================================
    // GANJA.JS LOADER WITH FALLBACKS
    // ========================================================================
    
    function loadGanja(callback) {
        const sources = [
            'https://cdnjs.cloudflare.com/ajax/libs/ganja.js/1.0.204/ganja.min.js',
            'https://unpkg.com/ganja.js@1.0.204/ganja.js',
            'https://cdn.jsdelivr.net/npm/ganja.js@1.0.204/ganja.min.js'
        ];
        
        let index = 0;
        function tryNext() {
            if (index >= sources.length) {
                callback(false);
                return;
            }
            const script = document.createElement('script');
            script.src = sources[index++];
            script.onload = () => callback(true);
            script.onerror = tryNext;
            document.head.appendChild(script);
        }
        tryNext();
    }

    // ========================================================================
    // INITIALIZATION
    // ========================================================================
    
    loadGanja(function(success) {
        const statusEl = document.getElementById('status');
        
        if (success) {
            statusEl.className = 'status success';
            statusEl.textContent = '✓ ganja.js loaded successfully';
            initGanjaDemo();
        } else if (typeof GA !== 'undefined') {
            statusEl.className = 'status fallback';
            statusEl.textContent = '⚠ ganja.js unavailable, using vanilla GA fallback';
            initVanillaDemo();
        } else {
            statusEl.className = 'status error';
            statusEl.textContent = '✗ No GA library available';
        }
    });

    // ========================================================================
    // GANJA.JS DEMO (when CDN works)
    // ========================================================================
    
    function initGanjaDemo() {
        // 2D PGA
        Algebra(2,0,1, function() {
            var e0 = 1e0, e1 = 1e1, e2 = 1e2;
            var e01 = 1e01, e02 = 1e02, e12 = 1e12;
            
            var origin = 1e12;
            var point = (x,y) => origin + x*(-1e02) + y*(1e01);
            
            var A = point(-0.5, -0.5);
            var B = point(0.5, -0.5);
            var C = point(0, 0.5);
            
            var angle = 0;
            var rotor = () => Math.cos(angle/2) + Math.sin(angle/2)*e12;
            
            var graph = this.graph([
                0xdd4444, A, "A",
                0x44dd44, B, "B",
                0x4444dd, C, "C",
                0x888888, () => A&B, () => B&C, () => C&A,
                0xffaaaa, () => rotor() >>> A,
                0xaaffaa, () => rotor() >>> B,
                0xaaaaff, () => rotor() >>> C,
            ], { grid: true, labels: true, lineWidth: 2, pointRadius: 5 });
            
            document.getElementById('pga2d-graph').appendChild(graph);
            
            document.getElementById('rotation2d').addEventListener('input', function(e) {
                angle = parseFloat(e.target.value) * Math.PI / 180;
                document.getElementById('rotation2d-val').textContent = e.target.value + '°';
            });
        });

        // 3D PGA
        Algebra(3,0,1, function() {
            var origin = 1e123;
            var point = (x,y,z) => origin + x*(-1e023) + y*(1e013) + z*(-1e012);
            
            var A = point(1, 0, -0.707);
            var B = point(-1, 0, -0.707);
            var C = point(0, 1, 0.707);
            var D = point(0, -1, 0.707);
            
            var angleX = 0, angleY = 0;
            var rotorX = () => Math.cos(angleX/2) + Math.sin(angleX/2)*(1e23);
            var rotorY = () => Math.cos(angleY/2) + Math.sin(angleY/2)*(1e13);
            var rotor = () => rotorY() * rotorX();
            
            var graph = this.graph([
                0xff0000, A, "A", 0x00ff00, B, "B",
                0x0000ff, C, "C", 0xffff00, D, "D",
                0x888888, [A,B], [B,C], [C,A], [A,D], [B,D], [C,D],
                0xffaaaa, () => rotor() >>> A,
                0xaaffaa, () => rotor() >>> B,
                0xaaaaff, () => rotor() >>> C,
                0xffffaa, () => rotor() >>> D,
            ], { grid: true, lineWidth: 2, pointRadius: 4, scale: 0.8, animate: true });
            
            document.getElementById('pga3d-graph').appendChild(graph);
            
            document.getElementById('rotationX').addEventListener('input', function(e) {
                angleX = parseFloat(e.target.value) * Math.PI / 180;
                document.getElementById('rotationX-val').textContent = e.target.value + '°';
            });
            document.getElementById('rotationY').addEventListener('input', function(e) {
                angleY = parseFloat(e.target.value) * Math.PI / 180;
                document.getElementById('rotationY-val').textContent = e.target.value + '°';
            });
        });
    }

    // ========================================================================
    // VANILLA GA DEMO (fallback)
    // ========================================================================
    
    function initVanillaDemo() {
        // Create canvas-based visualizations using vanilla GA
        const pga2d = GA.pga2d();
        const pga3d = GA.pga3d();
        
        // 2D Demo
        const canvas2d = document.createElement('canvas');
        canvas2d.width = 300;
        canvas2d.height = 300;
        document.getElementById('pga2d-graph').appendChild(canvas2d);
        const ctx2d = canvas2d.getContext('2d');
        
        let angle2d = 0;
        const points2d = [[-0.5, -0.5], [0.5, -0.5], [0, 0.5]];
        
        function draw2d() {
            ctx2d.fillStyle = '#fff';
            ctx2d.fillRect(0, 0, 300, 300);
            
            // Draw grid
            ctx2d.strokeStyle = '#eee';
            for (let i = 0; i <= 10; i++) {
                ctx2d.beginPath();
                ctx2d.moveTo(i * 30, 0); ctx2d.lineTo(i * 30, 300);
                ctx2d.moveTo(0, i * 30); ctx2d.lineTo(300, i * 30);
                ctx2d.stroke();
            }
            
            const cx = 150, cy = 150, scale = 100;
            const R = GA.Rotor3D.fromAxisAngle(0, 0, 1, angle2d);
            
            // Original triangle
            ctx2d.strokeStyle = '#888';
            ctx2d.beginPath();
            points2d.forEach((p, i) => {
                const x = cx + p[0] * scale, y = cy - p[1] * scale;
                if (i === 0) ctx2d.moveTo(x, y);
                else ctx2d.lineTo(x, y);
            });
            ctx2d.closePath();
            ctx2d.stroke();
            
            // Rotated triangle
            ctx2d.strokeStyle = '#c44';
            ctx2d.fillStyle = 'rgba(255,100,100,0.3)';
            ctx2d.beginPath();
            points2d.forEach((p, i) => {
                const [rx, ry] = R.apply(p[0], p[1], 0);
                const x = cx + rx * scale, y = cy - ry * scale;
                if (i === 0) ctx2d.moveTo(x, y);
                else ctx2d.lineTo(x, y);
            });
            ctx2d.closePath();
            ctx2d.fill();
            ctx2d.stroke();
        }
        
        draw2d();
        document.getElementById('rotation2d').addEventListener('input', function(e) {
            angle2d = parseFloat(e.target.value) * Math.PI / 180;
            document.getElementById('rotation2d-val').textContent = e.target.value + '°';
            draw2d();
        });
        
        // 3D Demo (simplified)
        const canvas3d = document.createElement('canvas');
        canvas3d.width = 300;
        canvas3d.height = 300;
        document.getElementById('pga3d-graph').appendChild(canvas3d);
        const ctx3d = canvas3d.getContext('2d');
        
        let angleX = 0, angleY = 0;
        const tetra = [[1,0,-0.707], [-1,0,-0.707], [0,1,0.707], [0,-1,0.707]];
        const edges = [[0,1],[0,2],[0,3],[1,2],[1,3],[2,3]];
        
        function project(x, y, z) {
            const d = 4, scale = 80;
            const p = d / (d - z);
            return [150 + x * scale * p, 150 - y * scale * p];
        }
        
        function draw3d() {
            ctx3d.fillStyle = '#fff';
            ctx3d.fillRect(0, 0, 300, 300);
            
            const Rx = GA.Rotor3D.fromAxisAngle(1, 0, 0, angleX);
            const Ry = GA.Rotor3D.fromAxisAngle(0, 1, 0, angleY);
            const R = Ry.mul(Rx);
            
            const transformed = tetra.map(p => R.apply(...p));
            const projected = transformed.map(p => project(...p));
            
            ctx3d.strokeStyle = '#888';
            ctx3d.lineWidth = 2;
            edges.forEach(([i, j]) => {
                ctx3d.beginPath();
                ctx3d.moveTo(...projected[i]);
                ctx3d.lineTo(...projected[j]);
                ctx3d.stroke();
            });
            
            const colors = ['#f00', '#0f0', '#00f', '#ff0'];
            projected.forEach(([x, y], i) => {
                ctx3d.fillStyle = colors[i];
                ctx3d.beginPath();
                ctx3d.arc(x, y, 6, 0, Math.PI * 2);
                ctx3d.fill();
            });
        }
        
        draw3d();
        document.getElementById('rotationX').addEventListener('input', function(e) {
            angleX = parseFloat(e.target.value) * Math.PI / 180;
            document.getElementById('rotationX-val').textContent = e.target.value + '°';
            draw3d();
        });
        document.getElementById('rotationY').addEventListener('input', function(e) {
            angleY = parseFloat(e.target.value) * Math.PI / 180;
            document.getElementById('rotationY-val').textContent = e.target.value + '°';
            draw3d();
        });
    }
    </script>
</body>
</html>
